<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê¸€ë¡œë²Œ ì¬ë‚œ ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ (ëŒ€ë¥™ë³„ ë¶„ë¥˜)</title>
    <style>
        body { font-family: 'Pretendard', sans-serif; line-height: 1.6; padding: 20px; background-color: #f0f4f8; color: #333; }
        .container { max-width: 1400px; margin: 0 auto; background: #fff; padding: 30px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #edf2f7; padding-bottom: 20px; margin-bottom: 20px; }
        h1 { font-size: 1.8rem; color: #1a202c; margin: 0; }
 
       /* Update ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
.update-btn {
    background: #4299e1;
    color: white;
    border: none;
    padding: 10px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    margin-left: 10px;
}
.update-btn:hover {
    background: #3182ce;
}
        /* ëŒ€ë¥™ë³„ í—¤ë” ìŠ¤íƒ€ì¼ */
        .continent-header { background-color: #2d3748; color: white; padding: 10px 20px; margin-top: 30px; border-radius: 8px; font-size: 1.1rem; font-weight: bold; }
        .priority-header { background-color: #e53e3e; color: white; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        th, td { padding: 12px; text-align: center; border-bottom: 1px solid #edf2f7; }
        th { background-color: #f7fafc; color: #4a5568; font-weight: 700; }
        
        /* 4ê°œêµ­ ê°•ì¡° ìŠ¤íƒ€ì¼ */
        .priority-row { background-color: #fff5f5 !important; border-left: 5px solid #e53e3e; }
        .priority-row td { color: #c53030 !important; font-weight: bold; }
        
        .badge { padding: 4px 8px; border-radius: 4px; color: white; font-weight: bold; font-size: 0.8rem; }
        .bg-red { background-color: #e53e3e; }
        .bg-orange { background-color: #ed8936; }
        .bg-gray { background-color: #a0aec0; }

        .time-info { font-weight: bold; color: #2d3748; }
        .time-ago { display: block; font-size: 0.75rem; color: #718096; font-weight: normal; }
        .location-text { font-size: 0.8rem; color: #718096; display
: block; margin-top: 4px; font-weight: normal; }
        .map-btn { display: inline-block; background: #ebf8ff; color: #2b6cb0; padding: 3px 7px; border-radius: 4px; text-decoration: none; font-size: 0.8rem; font-weight: bold; }

        .btn-noti { background: #38a169; color: white; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        #update-time { font-size: 0.85rem; color: #a0aec0; text-align: right; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>ğŸŒ ê¸€ë¡œë²Œ ì¬ë‚œ ëª¨ë‹ˆí„°ë§ </h1>
        <div>
            <button class="btn-noti" onclick="requestNotificationPermission()">ğŸ”” 4ê°œêµ­ ê¸´ê¸‰ ì•Œë¦¼ í™œì„±í™”</button>
            <div id="update-time"></div>
        </div>
    </div>

    <h2 style="color:#e53e3e; margin-bottom:0;">âš ï¸ ì‹¤ì‹œê°„ ì§€ì§„ í˜„í™© (ë°œìƒ ì‹œê° ê¸°ì¤€)</h2>
    <div id="quake-container">
        </div>

    <h2 style="color:#3182ce; margin-top:50px;">ğŸŒ€ ì‹¤ì‹œê°„ íƒœí’ í˜„í™©</h2>
    <div id="typhoon-container">
        <table>
            <thead>
                <tr><th>ë“±ê¸‰</th><th>íƒœí’ëª…</th><th>ë°œìƒ ì‹œì </th><th>ì˜í–¥ê¶Œ ë° ìƒì„¸ì§€ë„</th><th>ì¢Œí‘œ</th></tr>
            </thead>
            <tbody id="typhoon-list"></tbody>
        </table>
    </div>
</div>

<script>
    const targetCountries = ["Korea", "Japan", "Taiwan", "China"];
    let notifiedIds = new Set();

    // ëŒ€ë¥™ íŒë³„ ë¡œì§ (ìœ„ë„/ê²½ë„ ê¸°ë°˜)
    function getContinent(lat, lon, place) {
        if (targetCountries.some(c => place.includes(c))) return "ğŸš¨ ì¤‘ì  ê°ì‹œ (ë™ì•„ì‹œì•„ 4ê°œêµ­)";
        
        if (lon > 60 && lon < 150 && lat > -10 && lat < 80) return "ì•„ì‹œì•„ (Asia)";
        if (lon > -170 && lon < -30) return "ì•„ë©”ë¦¬ì¹´ (Americas)";
        if (lon > -20 && lon < 60 && lat > -40 && lat < 80) return "ìœ ëŸ½ & ì•„í”„ë¦¬ì¹´ (Europe & Africa)";
        if (lon > 110 &&lon < 180 && lat > -50 && lat < 10) return "ì˜¤ì„¸ì•„ë‹ˆì•„ (Oceania)";
        if (lon > -180 && lon < -170 || lon > 170) return "ì˜¤ì„¸ì•„ë‹ˆì•„/íƒœí‰ì–‘ (Oceania/Pacific)";
        return "ê¸°íƒ€ ì§€ì—­ (Other Regions)";
    }

    function getTimeAgo(date) {
        const seconds = Math.floor((new Date() - date) / 1000);
        if (seconds < 60) return `${seconds}ì´ˆ ì „`;
        const minutes = Math.floor(seconds / 60);
        if (minutes < 60) return `${minutes}ë¶„ ì „`;
        const hours = Math.floor(minutes / 60);
        if (hours < 24) return `${hours}ì‹œê°„ ì „`;
        return `${Math.floor(hours / 24)}ì¼ ì „`;
    }

    function requestNotificationPermission() {
        Notification.requestPermission();
    }

    // ì§€ì§„ í…Œì´ë¸” ë Œë”ë§
    function renderQuakeData(events) {
        const container = document.getElementById('quake-container');
        container.innerHTML = "";

        // ëŒ€ë¥™ë³„ ê·¸ë£¹í™”
        const groups = {};
        const continentOrder = ["ğŸš¨ ì¤‘ì  ê°ì‹œ (ë™ì•„ì‹œì•„ 4ê°œêµ­)", "ì•„ì‹œì•„ (Asia)", "ì•„ë©”ë¦¬ì¹´ (Americas)", "ìœ ëŸ½ & ì•„í”„ë¦¬ì¹´ (Europe & Africa)", "ì˜¤ì„¸ì•„ë‹ˆì•„ (Oceania)", "ì˜¤ì„¸ì•„ë‹ˆì•„/íƒœí‰ì–‘ (Oceania/Pacific)", "ê¸°íƒ€ ì§€ì—­ (Other Regions)"];

        events.forEach(q => {
            const [lon, lat] = q.geometry.coordinates;
            const continent = getContinent(lat, lon, q.properties.place);
            if (!groups[continent]) groups[continent] = [];
            groups[continent].push(q);
        });

        continentOrder.forEach(name => {
            if (!groups[name] || groups[name].length === 0) return;

            const section = document.createElement('div');
            const isPriority = name.includes("ğŸš¨");
            section.className = `continent-header ${isPriority ? 'priority-header' : ''}`;
            section.innerText = name;
            container.appendChild(section);

            const table = document.createElement('table');
            table.innerHTML = `<thead><tr><th>ì§€ì—­</th><th>ë°œìƒ ì‹œê°</th><th>ê·œëª¨</th><th>ìƒì„¸ì§€ë„</th><th>ê¹Šì´</th></tr></thead>`;
            const tbody = document.createElement('tbody');

            groups[name].slice(0, 15).forEach(q => {
                const p = q.properties;
                const coords = q.geometry.coordinates;
                const occurDate = new Date(p.time);
                const isTarget = isPriority;

                if (isTarget && !notifiedIds.has(p.ids)) {
                    if (Notification.permission === 'granted') {
                        new Notification(`ğŸš¨ 4ê°œêµ­ ì§€ì§„ ë°œìƒ: ${p.place}`, { body: `ê·œëª¨ M ${p.mag.toFixed(1)} / ì‹œê°: ${occurDate.toLocaleTimeString()}` });
                    }
                    notifiedIds.add(p.ids);
                }

                const rowClass = isTarget ? "priority-row" : "";
                const magClass = p.mag >= 5 ? 'bg-red' : (p.mag >= 3 ? 'bg-orange' : 'bg-gray');

                tbody.innerHTML += `
                    <tr class="${rowClass}">
                        <td><strong>${p.place.split(', ').pop()}</strong></td>
                        <td><span class="time-info">${occurDate.toLocaleString()}</span><span class="time-ago">${getTimeAgo(occurDate)}</span></td>
                        <td><span class="badge ${magClass}">M ${p.mag.toFixed(1)}</span></td>
                        <td><a href="${p.url}/map" target="_blank" class="map-btn">USGS ê³µì‹ì§€ë„</a><span class="location-text">${p.place}</span></td>
                        <td>${coords[2].toFixed(1)} km</td>
                    </tr>`;
            });
            table.appendChild(tbody);
            container.appendChild(table);
        });
    }

    async function fetchData() {
        try {
            const qRes = await fetch("https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/all_day.geojson");
            const qData = await qRes.json();
            renderQuakeData(qData.features);const tRes = await fetch("https://www.gdacs.org/gdacsapi/api/events/geteventlist/events4app?eventtypes=TC");
            const tData = await tRes.json();
            const tBody = document.getElementById('typhoon-list');
            tBody.innerHTML = "";
            
            // íƒœí’ ì •ë ¬ (4ê°œêµ­ ìš°ì„ )
            const tEvents = tData.features.filter(f => f.properties.eventtype === 'TC');
            const tPriority = tEvents.filter(t => targetCountries.some(c => t.properties.description.includes(c)));
            const tOthers = tEvents.filter(t => !targetCountries.some(c => t.properties.description.includes(c)));
            
            [...tPriority, ...tOthers].forEach(t => {
                const p = t.properties;
                const isTarget = targetCountries.some(c => p.description.includes(c));
                const occurDate = new Date(p.fromdate);
                const alertClass = p.alertlevel === 'Red' ? 'bg-red' : (p.alertlevel === 'Orange' ? 'bg-orange' : 'bg-blue');

                tBody.innerHTML += `
                    <tr class="${isTarget ? 'priority-row' : ''}">
                        <td><span class="badge ${alertClass}">${p.alertlevel}</span></td>
                        <td><strong>${p.name}</strong></td>
                        <td><span class="time-info">${occurDate.toLocaleString()}</span><span class="time-ago">${getTimeAgo(occurDate)}</span></td>
                        <td><a href="https://www.gdacs.org/report.aspx?eventid=${p.eventid}&eventtype=TC" target="_blank" class="map-btn">GDACS ê²½ë¡œ</a><div class="location-text">${p.description.split(';')[0]}</div></td>
                        <td>${t.geometry.coordinates[1].toFixed(2)}, ${t.geometry.coordinates[0].toFixed(2)}</td>
                    </tr>`;
            });

            document.getElementById('update-time').innerText = `ìµœê·¼ ë™ê¸°í™”: ${new Date().toLocaleTimeString()}`;
        } catch (e) { console.error(e); }
    }

    fetchData();
    setInterval(fetchData, 600000);
</script>

</body>
</html>
